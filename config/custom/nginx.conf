## ğŸš¨ WARNING ğŸš¨
#
# This file is under version control!
# DO NOT EDIT DIRECTLY - If you do, you'll loose your changes!
#
# The original file is in `/var/www/turbolab.it/config/custom/`
#
# You MUST:
#
# 1. edit the original file on you PC
# 2. Git-commit+push the changes
# 3. run `sudo bash /var/www/turbolab.it/scripts/deploy.sh`
#
# âš ï¸ This file is SHARED among dev|staging|prod âš ï¸
#
# ğŸª„ Based on https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/config/custom/nginx-symfony.conf

set $APP_NAME turbolab.it;

## ğŸŒ public webroot ("htdocs")
root $PROJECT_DIR/public;

## ğŸ”¢ PHP version to use
set $PHP_VER 8.3;

## ğŸ§° Maintenace - To activate:
# https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/scripts/maintenance.sh
include /usr/local/turbolab.it/webstackup/config/nginx/06_maintenace.conf;

## ğŸ›£ Redirect map
if ($wsuRedirectToMapTurbolabit) {
  return 301 $wsuRedirectToMapTurbolabit;
}

## 103 Early Hints
add_header Link "<https://fonts.googleapis.com/css2?family=Heebo:wght@100;300;400;500;600;700;800;900&display=swap>; as=style; rel=preload;" always;
add_header Link "<https://fonts.gstatic.com>; rel=preconnect; crossorigin" always;
add_header Link "<https://cdn.jsdelivr.net>; rel=preconnect;" always;
add_header Link "<https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css>; as=style; rel=preload;" always;
add_header Link "<https://code.jquery.com>; rel=preconnect;" always;


## ğŸ‘‰ğŸ» Extra-security (requires a valid HTTPS certificate)
#include /usr/local/turbolab.it/webstackup/config/nginx/70_security.conf;

## ğŸ’¬ phpBB (forum)
include /usr/local/turbolab.it/webstackup/config/nginx/10_phpbb_forum_location.conf;

## Non-Symfony pages
rewrite ^/ajax/login/$ /special-pages/login.php last;
rewrite ^/ajax/commenti/([1-9]+[0-9]*)$ /special-pages/comments.php?id=$1 last;
rewrite ^/comments-topic-update/$ /special-pages/comments-topic-update.php last;
rewrite ^/issue-add-to-post/$ /special-pages/issues.php last;
location ^~ /special-pages/ {
  try_files  $uri =404;
  include fastcgi_params;
  fastcgi_intercept_errors on;
  fastcgi_pass unix:/run/php/php$PHP_VER-fpm.sock;
  fastcgi_param  SCRIPT_FILENAME  $request_filename;
}

## X-Sendfile
# https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/
# https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/
location ^~ /xsend-uploaded-assets {
    internal;
    alias $PROJECT_DIR/var/uploaded-assets;
    expires 365d;
    add_header x-tli-xsent true;
}

## ğŸ“ Symfony
include /usr/local/turbolab.it/webstackup/config/nginx/07_symfony_location.conf;

##
location ^~ /immagini/ {
  allow all;
  expires 365d;
  rewrite ^/immagini/([a-z]+)/([1-9]+[0-9]*)/([^/]+-)([1-9]+[0-9]*\.[^/]+)$ /immagini/$1/$2/$4 break;
  try_files $uri /index.php$is_args$args;
}

## ğŸ«´ğŸ» Shared Nginx config
# https://github.com/TurboLabIt/webstackup/blob/master/config/nginx/common-bundle.conf
include /usr/local/turbolab.it/webstackup/config/nginx/common-bundle.conf;

## ğŸ§¹ Clean the root
rewrite ^/favicon\.ico$ /images/logo/2013/favicon.ico last;
rewrite ^/apple-touch-icon\.png$ /images/logo/2013/ttt-192px-tiny.png last;
rewrite ^/images/logo/icon\.png$ /images/logo/2013/ttt-192px-tiny.png last;
rewrite ^/robots\.txt$ /misc/robots.txt last;
rewrite ^/ads\.txt$ /misc/ads.txt last;
rewrite ^/open-?search\.xml$ /misc/open-search.xml last;


location /sitemap/ {
  alias $PROJECT_DIR/var/sitemaps/;
  ## ğŸ¡ Disable serving unrequested .gz files automatically
  # the correct URL (.xml or .xml.gz) must be used explicitely
  # https://nginx.org/en/docs/http/ngx_http_gzip_static_module.html
  gzip_static off;
}

## ğŸƒâ€â™‚ï¸ Async runner (requires a related cron job)
#include /usr/local/turbolab.it/webstackup/config/nginx/45_async-runner-request.conf;

## ğŸ“ƒ Logging
error_log /var/log/nginx/turbolab.it_error.log;
access_log /var/log/nginx/turbolab.it_access.log;
