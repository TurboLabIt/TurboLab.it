## üö® WARNING üö®
#
# This file is under version control!
# DO NOT EDIT DIRECTLY - If you do, you'll loose your changes!
#
# The original file is in `/var/www/turbolab.it-next/config/custom/staging/`
#
# You MUST:
#
# 1. edit the original file on you PC
# 2. Git-commit+push the changes
# 3. run `sudo bash /var/www/turbolab.it-next/scripts/deploy.sh`
#
# ‚ö†Ô∏è This file is for the STAGING env only ‚ö†Ô∏è
#
# ü™Ñ Based on https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/config/custom/staging/nginx.conf

map $request_uri $wsuRedirectToMapTurbolabit {
  include /var/www/turbolab.it-next/config/custom/redirects/redirect-map*.conf;
  ## default value will be an empty string
}


## MAIN server{} configuration
server {

  server_name next.turbolab.it;

  ## üè† App directory
  set $PROJECT_DIR /var/www/turbolab.it-next;

  ## üîè To obtain a valid certificate from Let's Encrypt:
  # certbot --email info@turbolab.it --agree-tos certonly --webroot -w /var/www/turbolab.it/public -d turbolab.it -d www.turbolab.it -d statistiche.turbolab.it
  ssl_certificate /etc/letsencrypt/live/turbolab.it/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turbolab.it/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/turbolab.it/cert.pem;

  ## üöß HTTP Auth on staging
  include /usr/local/turbolab.it/webstackup/config/nginx/30_httpauth.conf;
  # TODO: include the following in prod only
  #include /etc/turbolab.it/webstackup-nginx-allow-deny-list*.conf;

  ## ü§ñ Autodeploy on staging
  # https://github.com/TurboLabIt/webstackup/blob/master/script/php-pages/readme.md#how-to-autodeploy
  include /usr/local/turbolab.it/webstackup/config/nginx/45_autodeploy-async.conf;

  # Rate-limiting (activate only if common-bundle.conf is not in use)
  #include /usr/local/turbolab.it/webstackup/config/nginx/90_rate-limit.conf;

  ## üìú Shared config
  include /var/www/turbolab.it-next/config/custom/nginx.conf;
}


## redirect www.turbolab.it to turbolab.it
# TEMPORARY - THIS WILL GO TO THE PROD ENV, WHEN READY
server {

  server_name www.next.turbolab.it;

  ## Enable HTTPS
  include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;

  ## copy the certs from the actual server{}
  ssl_certificate /etc/letsencrypt/live/turbolab.it/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turbolab.it/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/turbolab.it/cert.pem;

  return 301 https://$host$request_uri;
}
