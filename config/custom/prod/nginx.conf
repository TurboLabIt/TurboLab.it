## ğŸš¨ WARNING ğŸš¨
#
# This file is under version control!
# DO NOT EDIT DIRECTLY - If you do, you'll loose your changes!
#
# The original file is in `/var/www/turbolab.it/config/custom/prod/`
#
# You MUST:
#
# 1. edit the original file on you PC
# 2. Git-commit+push the changes
# 3. run `sudo bash /var/www/turbolab.it/scripts/deploy.sh`
#
# âš ï¸ This file is for the PROD env only âš ï¸
#
# ğŸª„ Based on https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/config/custom/staging/nginx.conf

map $request_uri $wsuRedirectToMapTurbolabit {
  include /var/www/turbolab.it/config/custom/redirects/redirect-map*.conf;
  ## default value will be an empty string
}


## ğŸ­ MAIN server{} configuration
server {

  server_name turbolab.it;

  ## ğŸ  App directory
  set $PROJECT_DIR /var/www/turbolab.it;

  ## ğŸ” HTTPS certificates (to generate: bash scripts/https-generate-certs.sh)
  ssl_certificate /etc/letsencrypt/live/turbolab.it/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turbolab.it/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/turbolab.it/cert.pem;

  include /etc/turbolab.it/webstackup-nginx-allow-deny-list*.conf;

  ## ğŸ“œ Shared config
  include /var/www/turbolab.it/config/custom/nginx.conf;
}


## â†—ï¸ redirect www.turbolab.it to turbolab.it
server {

  server_name www.turbolab.it;

  ## Enable HTTPS
  include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;

  ## copy the certs from the actual server{}
  ssl_certificate /etc/letsencrypt/live/turbolab.it/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turbolab.it/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/turbolab.it/cert.pem;

  return 301 https://turbolab.it$request_uri;
}


## â†—ï¸ redirect bug.turbolab.it
server {

  server_name bug.turbolab.it;
  root /var/www/proxyall-webroot;

  ## Enable HTTPS
  include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;

  ## copy the certs from the actual server{}
  ssl_certificate /etc/letsencrypt/live/turbolab.it-bug/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turbolab.it-bug/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/turbolab.it-bug/cert.pem;

  location ^~ /.well-known {
      allow all;
  }

  location / {
    return 302 https://github.com/TurboLabIt/TurboLab.it/issues;
  }
}


## ğŸšª gateway-1 to next.turbolab.it
## ğŸ“š https://github.com/TurboLabIt/TurboLab.it/blob/main/docs/next-server.md
server {

  server_name next.turbolab.it;

  ## ğŸ” Real HTTPS certificate (public-facing gateway)
  ssl_certificate /etc/letsencrypt/live/turbolab.it-next-gateway/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/turbolab.it-next-gateway/privkey.pem;
  ssl_trusted_certificate /etc/letsencrypt/live/turbolab.it-next-gateway/cert.pem;

  ##ğŸ“š https://github.com/TurboLabIt/webstackup/blob/master/config/nginx/stargate-proxy.conf
  #ğŸ‘‡ğŸ‘‡ set $tier_IV_datacenter_ip xxx.xxx.xxx.xxx;
  include /etc/turbolab.it/tier-IV-datacenter-ip.conf;
  set $proxy_pass_target https://$tier_IV_datacenter_ip:443;
  include /usr/local/turbolab.it/webstackup/config/nginx/stargate-proxy.conf;
}
